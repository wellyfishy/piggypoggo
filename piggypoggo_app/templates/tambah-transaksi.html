{% extends "base-dashboard.html" %} {% load static %}

{% block content %}
<div class="container">
    <div class="page-inner">
        <div class="page-header">
          <h3 class="fw-bold mb-3"></h3>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="card-title" style="margin-right: 10px;">Tambah Transaksi</div>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="nama_pembeli">Nama Pembeli.*</label>
                                <input type="text" class="form-control" id="nama_pembeli" name="nama_pembeli" placeholder="Nama pembeli..." value="" required>
                                <small id="nama_pembeliHelp" class="form-text text-muted">Masukkan Nama Lengkap/Panggilan.</small>
                            </div>
                            <div class="form-group">
                                <label for="tanggal">Tanggal Diambil.*</label>
                                <input type="date" class="form-control" id="tanggal" name="tanggal">
                                <small id="tanggal" class="form-text text-muted">Masukan tanggal hari tersebut.</small>
                            </div>
                            <div class="form-group">
                                <label for="babi">Pilih babi:</label>
                                <select class="form-select select2" name="babi" id="babi" multiple="multiple" style="width: 100%;" required>
                                    {% for babi in all_babis %}
                                    <option value="{{ babi.pk }}">{{ babi }} - Rp. {{ babi.formatted_harga }}</option>
                                    {% endfor %}
                                </select>
                            </div>  
                            <div class="form-group">
                                <label for="total_harga">Total Harga</label>
                                <input type="text" class="form-control" id="total_harga" name="total_harga" placeholder="Total harga..." value="" readonly>
                                <small id="total_hargaHelp" class="form-text text-muted">Total terhitung otomatis.</small>
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <a href="{% url 'transaksi' %}" class="btn btn-danger me-2">Kembali</a>
                                <button type="submit" class="btn btn-success">Tambah</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock content %}

{% block script %}
<script>
    $(document).ready(function() {
        $('.select2').select2({
          placeholder: "Pilih babi...",
          allowClear: true
        });

        
        $('#babi').on('change', function () {
            let total = 0;
            $(this).find('option:selected').each(function () {
                const text = $(this).text();
                const match = text.match(/Rp\.?\s?([\d\.]+)/);
                if (match) {
                    const number = parseInt(match[1].replace(/\./g, '')); 
                    total += number;
                }
            });

            $('#total_harga').val(total.toLocaleString('id-ID'));
        });

        document.querySelector("form").addEventListener("submit", function(e) {
        e.preventDefault(); // prevent normal submission

        // You may want to first send data with AJAX/fetch here, then:
        let nama = document.getElementById("nama_pembeli").value;
        let tanggal = document.getElementById("tanggal").value;
        let total = document.getElementById("total_harga").value;

        let notaWindow = window.open('', '', 'width=600,height=400');
        notaWindow.document.write('<html><head><title>Nota</title></head><body>');
        notaWindow.document.write('<h3>Nota Transaksi</h3>');
        notaWindow.document.write('<p><strong>Nama:</strong> ' + nama + '</p>');
        notaWindow.document.write('<p><strong>Tanggal:</strong> ' + tanggal + '</p>');
        notaWindow.document.write('<p><strong>Total Harga:</strong> ' + total + '</p>');
        notaWindow.document.write('</body></html>');
        notaWindow.document.close();
        notaWindow.print();

        // After print, you can now submit the form
        this.submit();
    });
    });
</script>
{% endblock script %}